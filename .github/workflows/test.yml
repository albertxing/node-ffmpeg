name: Test

on:
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
          
      - uses: actions/setup-node@v3.5.1
        with:
          node-version: latest

      - name: Build ffmpeg
        working-directory: ./src/ffmpeg
        run: |
          brew install automake shtool texi2html wget nasm
          ./configure
          make -j4

      - name: Build libffmpeg
        working-directory: ./src
        run: |
          make libffmpeg.a

      - name: npm
        run: npm i --ignore-scripts

      - name: Prebuild
        run: npx prebuild --napi

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: prebuild-mac
          path: prebuilds

  build-win:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      
      - uses: msys2/setup-msys2@v2
        with:
          msystem: MSYS
          path-type: inherit
          release: false
          install: >-
            make
            pkgconf
            diffutils
            nasm

      - name: Build ffmpeg and libffmpeg
        working-directory: ./src
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
          msys2 -c "./win/build.sh"
        shell: cmd

      - name: Build libffmpeg
        working-directory: ./src
        run: |
          make libffmpeg.a

      - name: npm
        run: npm i --ignore-scripts

      - name: Prebuild
        run: npx prebuild --napi

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: prebuild-win
          path: prebuilds
